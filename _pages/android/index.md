---
layout: page
title: Android
permalink: /android/
---

TODO: make this on english

Данный текст является оптимизированной версией OWASP Mobile Security Testing Guide.

Настройка тестового окружения:link

Инструментарий:link

Инструкция по тестированию:link

# Тестовое окружение

Для проведения тестирования безопасности Android приложения необходимо правильно настроить хост и иметь как минимум одно тестовое устройство, на которое будет устанавливаться исследуемое приложение. Собрать своё тестовое окружение можно почти на любой машине.

## Хост

Основное требование для машины хоста - Android Studio. При желании можно установить эмулятор устройтва и систему управления версиями SDK. 

Android Studio уже поставляется с эмулятором Android Virtual Device. Установленными SDK можно управлять также в Android Studio.

Кроме того, может потребоваться установка NDK.

## Тестовое устройство

Для динамического анализа вам необходмо устройство на Android. Можно не использовать физическое устройство, а только эмулятор. Но приложениея, которые вы запускаете на эмуляторе работают медленнее и могут не дать реального представления работы, однако позволяют просто создавать разные устройства с разным уровнем SDK. Эмуляторы обычно по-умолчанию имеют рут и позволяют создавать снимки файловой системы.

### Реальное устройтво

Почти все реальные устройства могут использоваться для тестирования. Для начала устройство должно иметь возможность получения рута. Обычно получение рута возможно с помощью эксплоита или через разблокированный загрузчик. Рут - это модификация системы таким образом, чтобы иметь возможность запуска команд от root пользователя. Получение рута рекомендуется для проведения тестирования приложения на реальных устройствах. Оно позволяет вам полностью контролировать операционную систему и выходить за рамки песочницы приложения.
Инструкции по получению рута для конкретных устройств можно найти на порталах типа 4pda или xda.

Лучше всего для исследования подойдут устройства крупных производителей, например Samsung, LG и устройства, поддерживающие Linage OS. 

Для работы с физическим устройством необходимо включить режим разработчика и отладку по USB для использования интерфеса ADB.

### Эмуляторы

На рынке существует несколько решений для эмуляции:

* Android Virtual Device (AVD) - бесплатный официальный эмулятор, поставляемый с Android Studio;
* Genymotion - виртуализация на основе Virtual Box.

Обычно рекомендуется использовать, там где это возможно, AVD. К сожалению, с ним могут возникать определённые трудности:

* Некоторые приложения могут не иметь версии x86 и придется эмулировать arm, что значительно ударит по производительности;
* root по-умолчанию включён(adb root), но для активации приложений, которые требуют su доступ потребуется дополнительно установить supersu и произвести некоторую последовательность действий;
* Некоторые версии Android не позволяют переключить систему в режим для чтения, из-за чего не получается установить supersu и т.п.
* Эмуляция конкретных устройств затруднена - вам лишь дают скины. Это значит, что вы не сможете исследовать встроенные в прошивки приложения, которые взаимодействуют с конкретной системой.

Если что-то из вышеперечисленного вам не подходит, то можно использовать Genymotion.

## Инструментарий

Следующий раздел содержит необходимый минимальный набор инструментов и фреймворков для тестирования безопасности Android приложений.

### Устройство

Приложения и фреймворки из этого раздела требуют получения рут прав на исследуемом устройстве. Бесплатные версии APK можно найти в Google Play.

#### SU

su требуется для предоставления рут прав приложениям. Без этого инструмента будет сложно запустить сервер frida и использовать другие приложения этого раздела.

su устанавливается на рутованное устройство и прописывается в исполняемых файлах system/bin. 

Для установки на эмулятор AVD можно использовать инструкцию.

#### Xposed

Это приложение, которое позволяет устанавливать на Android устройство специальные модули. Модули позволяют кастомизировать устройство.
// 

#### Root Explorer

Это проводник с обширным функционалом и, если получен рут, возможностью просматривать и редактировать системные файлы.

Имеется весь функционал проводника: поиск, изменение прав, предпросмотр файлов, встроенный редактор и панелирование.

#### ProxyDroid

Прокси-клиент, в котором можно указывать какие приложения нужно отправлять через прокси. Доступна возможность перенаправлять трафик, который нельзя отправить через обычную настройку прокси в параметрах Wi-Fi.

### Хост

Этот раздел содержит инструменты для анализа и отладки Android приложений на вашем ПК.

#### ADB

adb(Android Debug Bridge), поставляется с Android SDK, создаёт канал между локальным ПК и Android устройством. Обычно используется для тестирования приложений на эмуляторе и, подключенном через USB/Wi-Fi, устройстве. Для получения полного функционала adb запрашивается разрешение на отладку.

Команда `adb devices` выводит список устройств, подключенных к компьютеру.

Также adb позволяет получить доступ к командной строке через `adb shell`

#### Angr

#### Apktool

Apktool инструмент для работы с APK файлами. Позволяет распаковывать и запаковывать модифицированные APK.
//

#### Burp Suite

Продвинутый инструмент для исследования безопасности.

Имеет функционал прокси-сервера, для перехвата трафика между приложением и сервером. Может прослушивать HTTPS, если установить CA сертификат на устройство.
//

#### Drozer

#### JADX

Java декомпилятор. Позволяет декомпилировать APK, dex, odex файлы.

Имеет удобный gui для просмотра декомпилированного кода, подключенных библиотек, ресурсов и манифеста. Имеет встроенный деобфускатор.

#### Vdex Extractor

Инструмент позволяет конвертировать современный формат хранения Android данных vdex в odex и dex, которые затем можно открыть в JADX или dex2jar-jdgui.

#### Frida

Frida это фреймворк для динамической работы с кодом, позволяющий выполнять JavaScript код внутри приложений.

Frida поддерживает работу с Android приложениями - можно захватывать и вызывать Java или нативные методы процесса и библиотек.

Также имеется набор frida-tools: frida-ps, frida-ls-devices и frida-trace.

Основные возможности Frida:
1. Переопределение Java метода;
2. Определение объектов Java и вызов статических методов;
3. Перехват вызова нативных методов.

Все возможности предоставляет frida-server, который устанавливается на устройство и запускается от рута.

Имеется версия frida-gadget, которая встраивается в приложение, как динамически загружаемая библиотека и не требует рута для функционала frida, правда ограниченный sandbox приложения.

//

#### MobSF

#### Objection

Objection это инструмент для анализа мобильных приложений, основанный на Frida. Основное его предназначение - это тестирование безопасности на не рутованных устройствах. Представляет собой набор скриптов и команд Frida. Использует функционал frida-gadget для взаимодействия с приложением.

Некоторые возможности Objection:
1. Внедрение frida-gadget в приложение одной командой;
2. Отключение SSL pinning;
3. Доступ к хранилищу приложения;
4. Выполнение скрипров Frida;
5. Запуск Activities.

Представляет собой более удобную версию frida-gadget с дополнительным функционалом и часто используется для динамического анализа приложений без получения рут доступа.
//

#### dex2jar

Набор инструментов для работы с dex файлами. Позволяет конвертировать dex/odex в jar (java .class файлы), выполнить операцию smali/backsmali. 

#### jd-gui

Утилита для просмотра Java .class файлов (jar). Имеет ограниченный функционал, поэтому рекомендуется использовать JADX.

#### radare2

#### r2frida

## Практика

Раздел содержит практическое применение инструментов для тестирования безопасности Android приложений.

### Подготовительная работа.

Перед тем, как начать исследование приложения, стоит понять его применение - для чего вообще это приложение и что оно делает. 

Бизнес логика некоторых приложений, например банковских, требует определённого уровня защищённости пользовательских данных, кода и каналов передачи. Другие приложения, например калькулятор, могут не работать с чувствительными данными и не иметь сильной защиты кода и собственных данных. Можно сказать, что в зависимости от применения приложения оно должно иметь определенные степени защиты и следовать неким стандартам безопасности.

### Потенциальные проблемы при исследовании.

Чем более чувствительными данными оперирует приложение, тем сильнее его безопаснсть. Такие приложения имеют встроенную защиту от реверса - динамическое шифрование кода, обфускацию кода, перенос опасных методов в нативные библиотеки, которые хуже поддаются исследованию и т.д.
